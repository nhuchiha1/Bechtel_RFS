<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Expert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .current-params {
            background-color: #e7f3ff;
        }
        .param-item {
            margin: 8px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .param-name {
            font-weight: bold;
            color: #007bff;
        }
        .param-value {
            color: #333;
            margin-left: 10px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 8px 5px;
            transition: all 0.3s;
            min-width: 140px;
            height: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        button:disabled {
            background-color: #6c757d !important;
            color: #dee2e6 !important;
            cursor: not-allowed !important;
            transform: none !important;
            opacity: 0.7;
            box-shadow: none;
        }
        button:disabled:hover {
            background-color: #6c757d !important;
            transform: none !important;
        }
        .action-button {
            background-color: #28a745;
        }
        .action-button:hover {
            background-color: #218838;
        }
        .action-button:disabled {
            background-color: #6c757d !important;
            color: #dee2e6 !important;
        }
        .call-now-button {
            background-color: #fd7e14;
        }
        .call-now-button:hover {
            background-color: #e8590c;
        }
        .call-now-button:disabled {
            background-color: #6c757d !important;
            color: #dee2e6 !important;
        }
        .clear-button {
            background-color: #dc3545;
        }
        .clear-button:hover {
            background-color: #c82333;
        }
        .generated-url {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin: 15px 0;
            word-break: break-all;
        }
        .url-display {
            font-family: monospace;
            font-size: 14px;
            color: #856404;
        }
        .example {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #6c757d;
        }
        .example-link {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
        }
        .example-link:hover {
            text-decoration: underline;
        }
        .no-params {
            color: #666;
            font-style: italic;
        }
        .qr-code {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            background-color: white;
            display: inline-block;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .qr-code img {
            display: block;
            margin: 0 auto;
        }
        .response-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .response-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .response-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .response-data {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .meeting-link {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .meeting-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            word-break: break-all;
        }
        .meeting-link a:hover {
            text-decoration: underline;
        }
        .launch-meeting-btn {
            background-color: #28a745 !important;
            color: white !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            margin: 8px 5px !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
            min-width: 140px !important;
            height: 50px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .launch-meeting-btn:hover {
            background-color: #218838 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        }
        .copy-link-btn {
            background-color: #007bff !important;
            color: white !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            margin: 8px 5px !important;
            transition: all 0.3s ease !important;
            min-width: 140px !important;
            height: 50px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .copy-link-btn:hover {
            background-color: #0056b3 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
            <img src="https://github.com/nhuchiha1/Bechtel_RFS/blob/main/bechtel%20bug.png" alt="Bechtel Logo" style="height: 50px; width: auto;">
            <span style="flex: 1; text-align: center;">Remote Expert</span>
            <img src="https://github.com/nhuchiha1/Bechtel_RFS/blob/main/RemoteServices.jpg" alt="Remote Services" style="height: 50px; width: auto;">
        </h1>
        
        <!-- Current URL Parameters Section -->
        <div class="section current-params" style="display: none;">
            <div id="currentParams"></div>
        </div>
        
        <!-- Generated URL Section -->
        <div class="section">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button onclick="navigateToNewUrl()" class="action-button">üöÄ Meet Now</button>
                <button onclick="callNowFlow()" class="call-now-button">üìû Call Now</button>
                <button onclick="closeBrowser()">‚ùå Close</button>
            </div>
        </div>

        <!-- Power Automate Response Section -->
        <div class="section" id="responseSection" style="display: none;">
            <!-- Launch Meeting Buttons Container -->
            <div id="meetingButtonsContainer" style="display: none; text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin: 15px 0; border: 2px solid #28a745;">
                <h4 style="margin: 0 0 15px 0; color: #28a745;">üöÄ Meeting Ready!</h4>
                <p style="margin: 10px 0; color: #666; font-size: 14px;">Your meeting has been created successfully!</p>
                <div id="meetingButtons"></div>
            </div>
            
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                <div style="display: inline-block; animation: spin 1s linear infinite; font-size: 24px;">‚è≥</div>
                <p>Processing your request...</p>
            </div>
        </div>
    </div>

    <script>
        // Store current parameters
        let currentUrlParams = {};
        let generatedUrl = '';
        
        // Extract parameters from current URL
        function extractCurrentParams() {
            const urlSearchParams = new URLSearchParams(window.location.search);
            currentUrlParams = {};
            
            for (const [key, value] of urlSearchParams.entries()) {
                currentUrlParams[key] = value;
            }
            
            return currentUrlParams;
        }
        
        // Display current URL parameters
        function displayCurrentParams() {
            const params = extractCurrentParams();
            const container = document.getElementById('currentParams');
            
            if (Object.keys(params).length === 0) {
                container.innerHTML = '<div class="no-params">No parameters found in current URL</div>';
                return;
            }
            
            // Define parameter organization
            const leftColumnParams = ['JobNumber', 'Discipline', 'LO'];
            const rightColumnParams = ['DocumentApp', 'DocumentType', 'DocumentNumber'];
            
            let leftColumnHtml = '';
            let rightColumnHtml = '';
            
            // Build left column
            leftColumnParams.forEach(paramKey => {
                if (params[paramKey]) {
                    leftColumnHtml += `
                        <div class="param-item">
                            <span class="param-name">${paramKey}:</span>
                            <span class="param-value">${params[paramKey]}</span>
                        </div>
                    `;
                }
            });
            
            // Build right column
            rightColumnParams.forEach(paramKey => {
                if (params[paramKey]) {
                    rightColumnHtml += `
                        <div class="param-item">
                            <span class="param-name">${paramKey}:</span>
                            <span class="param-value">${params[paramKey]}</span>
                        </div>
                    `;
                }
            });
            
            // Handle any additional parameters not in the defined lists
            const definedParams = [...leftColumnParams, ...rightColumnParams];
            let additionalHtml = '';
            for (const [key, value] of Object.entries(params)) {
                if (!definedParams.includes(key)) {
                    additionalHtml += `
                        <div class="param-item">
                            <span class="param-name">${key}:</span>
                            <span class="param-value">${value}</span>
                        </div>
                    `;
                }
            }
            
            // Create two-column layout
            let html = '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';
            
            if (leftColumnHtml) {
                html += `<div style="flex: 1; min-width: 200px;">${leftColumnHtml}</div>`;
            }
            
            if (rightColumnHtml) {
                html += `<div style="flex: 1; min-width: 200px;">${rightColumnHtml}</div>`;
            }
            
            html += '</div>';
            
            // Add any additional parameters below the columns
            if (additionalHtml) {
                html += `<div style="margin-top: 15px;"><strong>Additional Parameters:</strong></div>${additionalHtml}`;
            }
            
            container.innerHTML = html;
        }
        
        // Generate new URL with current parameters only
        function generateNewUrl() {
            const params = extractCurrentParams();
            
            // Base Azure Logic App URL
            //const baseUrl = "https://prod-93.westus.logic.azure.com:443/workflows/66498f28f8974a2f82a605792ede6f45/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=0b_P8FOodLdQA5o0G3Aq17k3C-0KwyM5LRbkPi7t_K0&";
            const baseUrl = "https://247644b0a466e4d68a01a244f6cb5f.19.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3e350daeceed49b690c5bda3aaa4ca00/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=fpX3RmQr9PaF5AEntKSWYNoZo37O0dOXFPrnpjp-bJ4&";
            
            if (Object.keys(params).length === 0) {
                // Even with no parameters, set the base URL
                generatedUrl = baseUrl.slice(0, -1); // Remove trailing &
            } else {
                // Create new URL with parameters
                const searchParams = new URLSearchParams(params);
                generatedUrl = baseUrl + searchParams.toString();
            }
            
            // Generate and display QR code
            generateQRCode(generatedUrl);
            
            console.log('Generated URL:', generatedUrl);
            console.log('Current parameters:', params);
        }
        
        // Generate QR code for the URL
        function generateQRCode(url) {
            const qrContainer = document.getElementById('qrCodeDisplay');
            
            if (!url) {
                qrContainer.innerHTML = '';
                return;
            }
            
            // Use QR Server API to generate QR code - larger size for better scanning
            const qrSize = 150;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(url)}`;
            
            qrContainer.innerHTML = `
                <div style="background-color: white; padding: 12px; border-radius: 8px; border: 2px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">

                    <img src="${qrUrl}" alt="QR Code for Power Automate URL" style="width: ${qrSize}px; height: ${qrSize}px; display: block;" />
                </div>
            `;
            
            console.log('QR Code generated for URL:', url);
        }
        

        
        // Navigate to the new URL
        async function navigateToNewUrl() {
            // Disable the Meet Now button to prevent multiple clicks
            const meetNowButton = event.target;
            const originalText = meetNowButton.innerHTML;
            meetNowButton.disabled = true;
            meetNowButton.style.cursor = 'not-allowed';
            meetNowButton.innerHTML = '‚è≥ Creating Meeting...';
            
            if (!generatedUrl) {
                alert('Please generate a URL first');
                // Re-enable button on error
                meetNowButton.disabled = false;
                meetNowButton.style.cursor = 'pointer';
                meetNowButton.innerHTML = originalText;
                return;
            }
            
            // Show response section and loading indicator
            document.getElementById('responseSection').style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                // Prepare the request body with current parameters
                const params = extractCurrentParams();
                const requestBody = {
                    ...params,
                    timestamp: new Date().toISOString(),
                    source: 'RFS_HTML_Interface'
                };
                
                console.log('Sending request to Power Automate:', generatedUrl);
                console.log('Request body:', requestBody);
                
                // Make the request to Power Automate flow
                const response = await fetch(generatedUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                if (response.ok) {
                    // Check if response has content before trying to parse JSON
                    const responseText = await response.text();
                    
                    if (!responseText || responseText.trim() === '') {
                        // Empty response - treat as success but no data
                        displaySuccessResponse({
                            message: 'Power Automate flow executed successfully',
                            status: response.status,
                            statusText: response.statusText,
                            note: 'No response data returned from the flow'
                        });
                    } else {
                        try {
                            // Try to parse as JSON
                            const responseData = JSON.parse(responseText);
                            displaySuccessResponse(responseData);
                        } catch (jsonError) {
                            // Not valid JSON - display as text response
                            displaySuccessResponse({
                                message: 'Power Automate flow completed',
                                status: response.status,
                                statusText: response.statusText,
                                rawResponse: responseText,
                                note: 'Response was not in JSON format'
                            });
                        }
                    }
                } else {
                    const errorText = await response.text();
                    // Re-enable button on HTTP error
                    meetNowButton.disabled = false;
                    meetNowButton.style.cursor = 'pointer';
                    meetNowButton.innerHTML = originalText;
                    displayErrorResponse(`HTTP ${response.status}: ${response.statusText}`, errorText);
                }
                
            } catch (error) {
                // Hide loading indicator and re-enable button on error
                document.getElementById('loadingIndicator').style.display = 'none';
                meetNowButton.disabled = false;
                meetNowButton.style.cursor = 'pointer';
                meetNowButton.innerHTML = originalText;
                console.error('Error calling Power Automate flow:', error);
                
                let errorTitle = 'Network Error';
                let errorMessage = error.message;
                
                // Provide more specific error messages
                if (error.message.includes('Failed to fetch')) {
                    errorTitle = 'Connection Error';
                    errorMessage = 'Unable to connect to Power Automate flow. Please check your internet connection and the flow URL.';
                } else if (error.message.includes('JSON')) {
                    errorTitle = 'Response Format Error';  
                    errorMessage = 'The Power Automate flow returned an invalid or empty response.';
                } else if (error.message.includes('CORS')) {
                    errorTitle = 'CORS Error';
                    errorMessage = 'Cross-origin request blocked. The Power Automate flow may need to be configured to allow requests from this domain.';
                }
                
                displayErrorResponse(errorTitle, errorMessage + '\n\nOriginal error: ' + error.message);
            }
        }
        
        // Call Now Flow - launches different Power Automate flow
        async function callNowFlow() {
            // Disable the Call Now button to prevent multiple clicks
            const callNowButton = event.target;
            const originalText = callNowButton.innerHTML;
            callNowButton.disabled = true;
            callNowButton.style.cursor = 'not-allowed';
            callNowButton.innerHTML = '‚è≥ Calling...';
            
            try {
                // Get current parameters
                const params = extractCurrentParams();
                
                // Different base URL for Call Now flow
                const callNowBaseUrl = "https://247644b0a466e4d68a01a244f6cb5f.19.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e4cc0f4f877e47b1a0bf10c300d5ae76/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=U4WonLnhC6JgYMmux8UlU0sYDz_fu1nLs-J64LZZz1o&";
                
                // Build Call Now URL with parameters
                let callNowUrl;
                if (Object.keys(params).length === 0) {
                    callNowUrl = callNowBaseUrl.slice(0, -1); // Remove trailing ?
                } else {
                    const searchParams = new URLSearchParams({
                        ...params,
                        timestamp: new Date().toISOString(),
                        source: 'Call_Now_Interface',
                        action: 'call_now'
                    });
                    callNowUrl = callNowBaseUrl + searchParams.toString();
                }
                
                console.log('Calling Call Now Flow:', callNowUrl);
                
                // Make the request to Call Now Power Automate flow
                const response = await fetch(callNowUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ...params,
                        timestamp: new Date().toISOString(),
                        source: 'Call_Now_Interface',
                        action: 'call_now'
                    })
                });
                
                if (response.ok) {
                    // Handle successful call
                    const responseText = await response.text();
                    console.log('Raw response text:', responseText);
                    let responseData;
                    
                    try {
                        // If response looks like a direct URL, don't try to parse as JSON
                        if (responseText && responseText.trim().startsWith('http')) {
                            console.log('Response appears to be direct URL, using as string');
                            responseData = responseText.trim();
                        } else {
                            responseData = responseText ? JSON.parse(responseText) : { success: true };
                        }
                        console.log('Parsed response data:', responseData);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.log('Treating as raw response text');
                        responseData = responseText || { success: true };
                    }
                    
                    // Check for URL in response to auto-launch
                    const launchUrl = extractCallNowUrl(responseData);
                    if (launchUrl) {
                        console.log('Launching Call Now URL:', launchUrl);
                        
                        // Show different message based on URL type
                        if (launchUrl.includes('teams.microsoft.com')) {
                            callNowButton.innerHTML = 'üìû Opening Teams Call...';
                        } else {
                            callNowButton.innerHTML = 'üìû Opening Call...';
                        }
                        
                        // Auto-launch the URL (Teams call, phone dialer, etc.)
                        setTimeout(() => {
                            window.open(launchUrl, '_blank');
                            // Update button after launch
                            callNowButton.innerHTML = '‚úÖ Call Launched';
                        }, 500);
                    } else {
                        // No URL found but call was successful
                        callNowButton.innerHTML = '‚úÖ Call Started';
                        console.warn('Call Now successful but no URL found in response');
                        console.log('Expected CallURL property not found in response');
                    }
                    
                    console.log('Call Now Flow Response:', responseData);
                    
                } else {
                    // Handle error response
                    const errorText = await response.text();
                    console.error('Call Now Flow Error:', response.status, errorText);
                    
                    // Re-enable button on error
                    callNowButton.disabled = false;
                    callNowButton.style.cursor = 'pointer';
                    callNowButton.innerHTML = originalText;
                    
                    alert(`Call failed: ${response.status} - ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Call Now Flow Network Error:', error);
                
                // Re-enable button on error
                callNowButton.disabled = false;
                callNowButton.style.cursor = 'pointer';
                callNowButton.innerHTML = originalText;
                
                alert(`Call failed: ${error.message}`);
            }
        }
        
        // Extract URL from Call Now response
        function extractCallNowUrl(responseData) {
            console.log('Extracting Call Now URL from response:', responseData);
            
            if (!responseData) {
                console.log('No response data provided');
                return null;
            }
            
            // Check for common URL properties in Call Now response (Teams-specific properties first)
            const urlProperties = [
                'CallURL', 'TeamsURL', 'teams_url', 'call_url', 'phone_url', 'teams_call_url', 
                'dialer_url', 'launch_url', 'url', 'link', 'redirect_url', 'target_url', 
                'meeting_url', 'join_url', 'URL', 'Call_URL', 'Teams_URL'
            ];
            
            // If response is a string URL
            if (typeof responseData === 'string') {
                console.log('Response is string:', responseData);
                
                // Clean up the string (remove quotes, whitespace, semicolons at the end)
                let cleanUrl = responseData.trim().replace(/^["']|["']$/g, '').replace(/;$/, '');
                console.log('Cleaned URL:', cleanUrl);
                
                // Check if it's a direct Teams URL
                if (cleanUrl.includes('teams.microsoft.com')) {
                    console.log('Found Teams URL in string response:', cleanUrl);
                    return cleanUrl;
                }
                
                // Check if it's any HTTP/HTTPS URL
                if (cleanUrl.match(/^https?:\/\//)) {
                    console.log('Found HTTP URL in string response:', cleanUrl);
                    return cleanUrl;
                }
                
                // Check if Teams URL is embedded in text
                const teamsMatch = responseData.match(/(https:\/\/teams\.microsoft\.com\/l\/[^\s;]+)/);
                if (teamsMatch) {
                    console.log('Found embedded Teams URL:', teamsMatch[1]);
                    return teamsMatch[1];
                }
            }
            
            // If response is an object, look for URL properties
            if (typeof responseData === 'object') {
                console.log('Response is object, checking properties...');
                
                for (const prop of urlProperties) {
                    if (responseData[prop] && typeof responseData[prop] === 'string') {
                        console.log(`Checking property ${prop}:`, responseData[prop]);
                        
                        // Prioritize Teams URLs
                        if (responseData[prop].includes('teams.microsoft.com')) {
                            console.log('Found Teams URL in property:', prop, responseData[prop]);
                            return responseData[prop].trim();
                        }
                        
                        // Any other HTTP/HTTPS URL
                        if (responseData[prop].match(/^https?:\/\//)) {
                            console.log('Found HTTP URL in property:', prop, responseData[prop]);
                            return responseData[prop].trim();
                        }
                    }
                }
            }
            
            console.log('No URL found in Call Now response');
            return null;
        }
        
        // Copy URL to clipboard
        function copyUrlToClipboard() {
            if (!generatedUrl) {
                alert('Please generate a URL first');
                return;
            }
            
            navigator.clipboard.writeText(generatedUrl).then(() => {
                alert('URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = generatedUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('URL copied to clipboard!');
            });
        }
        
        // Display successful Power Automate response
        function displaySuccessResponse(responseData) {
            const meetingButtonsContainer = document.getElementById('meetingButtonsContainer');
            const meetingButtons = document.getElementById('meetingButtons');
            
            // Reset meeting buttons
            meetingButtonsContainer.style.display = 'none';
            meetingButtons.innerHTML = '';
            
            // Handle case where responseData might be null or undefined
            if (!responseData || typeof responseData !== 'object') {
                return;
            }
            
            // Look for meeting URLs in various possible fields
            const possibleUrlFields = [
                'joinUrl', 'meetingUrl', 'webUrl', 'onlineMeetingUrl', 
                'joinWebUrl', 'meetingLink', 'teamsUrl', 'url'
            ];
            
            let meetingUrl = null;
            for (const field of possibleUrlFields) {
                if (responseData[field] && typeof responseData[field] === 'string') {
                    meetingUrl = responseData[field];
                    break;
                }
            }
            
            // If we found a meeting URL, display it prominently in the buttons container
            if (meetingUrl) {
                meetingButtonsContainer.style.display = 'block';
                meetingButtons.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button onclick="openMeetingUrl('${meetingUrl}')" class="launch-meeting-btn">
                            üé• Join Meeting
                        </button>
                        <div style="background-color: white; padding: 15px; border-radius: 8px; border: 2px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="text-align: center; margin-bottom: 8px;">
                                <span style="color: #007bff; font-size: 12px; font-weight: bold;">üì± Scan to Join</span>
                            </div>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(meetingUrl)}" 
                                 alt="QR Code for meeting" 
                                 style="width: 150px; height: 150px; display: block;" />
                        </div>
                    </div>
                `;
                
            }
            
            if (responseData.rawResponse) {
                // Check if raw response contains a URL pattern
                const urlPattern = /https?:\/\/[^\s<>"{}|\\^`[\]]+/gi;
                const urls = responseData.rawResponse.match(urlPattern);
                
                if (urls && urls.length > 0) {
                    // If URLs found, show buttons in the container at the top
                    const meetingUrl = urls[0];
                    meetingButtonsContainer.style.display = 'block';
                    meetingButtons.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <button onclick="openMeetingUrl('${meetingUrl}')" class="launch-meeting-btn">
                                üé• Join Meeting
                            </button>
                            <div style="background-color: white; padding: 15px; border-radius: 8px; border: 2px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <span style="color: #007bff; font-size: 12px; font-weight: bold;">üì± Scan to Join</span>
                                </div>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(meetingUrl)}" 
                                     alt="QR Code for meeting" 
                                     style="width: 150px; height: 150px; display: block;" />
                            </div>
                        </div>
                    `;
                    
                }
            }
            
            console.log('Power Automate Success Response:', responseData);
        }
        
        // Display error response
        function displayErrorResponse(errorTitle, errorDetails) {
            const meetingButtonsContainer = document.getElementById('meetingButtonsContainer');
            
            // Hide meeting buttons for errors
            meetingButtonsContainer.style.display = 'none';
            
            console.error('Power Automate Error:', errorTitle, errorDetails);
            alert(`‚ùå ${errorTitle}\n\nThe Power Automate flow encountered an error. Please check the console for details.`);
        }
        
        // Copy meeting link to clipboard
        function copyMeetingLink(meetingUrl) {
            navigator.clipboard.writeText(meetingUrl).then(() => {
                alert('Meeting link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy meeting link:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = meetingUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Meeting link copied to clipboard!');
            });
        }
        
        // Open meeting URL in new tab
        function openMeetingUrl(meetingUrl) {
            window.open(meetingUrl, '_blank');
        }
        
        // Refresh current parameters
        function refreshCurrentParams() {
            displayCurrentParams();
            generateNewUrl(); // Automatically generate URL when refreshing
        }
        
        // Close the browser window
        function closeBrowser() {
            // Try multiple approaches to close the window
            
            // Method 1: Try to close normally (works if window was opened by script)
            try {
                window.close();
                
                // Check if window is still open after a short delay
                setTimeout(() => {
                    if (!window.closed) {
                        // Method 2: Try using history.back() to navigate away
                        if (window.history.length > 1) {
                            window.history.back();
                        } else {
                            // Method 3: Navigate to a blank page
                            window.location.href = 'about:blank';
                        }
                    }
                }, 50);
                
            } catch (error) {
                // Method 4: Fallback - navigate to blank page immediately
                window.location.href = 'about:blank';
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            displayCurrentParams();
            generateNewUrl(); // Automatically generate URL on load
            console.log('Page loaded. Current URL parameters:', currentUrlParams);
        });
        
        // Update display when URL changes (for single-page applications)
        window.addEventListener('popstate', function() {
            displayCurrentParams();
            generateNewUrl(); // Automatically generate URL on URL change
        });
    </script>
</body>
</html>


